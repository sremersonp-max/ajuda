<div class="card">
    <h2 class="card-title"><i class="fas fa-database"></i> Backup e Restauração</h2>
    
    <div class="form-container">
        <h4 class="form-section-title"><i class="fas fa-shield-alt"></i> Backup do Sistema</h4>
        <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
            Faça backup de todos os dados do sistema para restaurar em outro dispositivo ou manter uma cópia de segurança.
            Recomenda-se fazer backup regularmente para prevenir perda de dados.
        </p>
        
        <div class="dashboard-grid mb-4">
            <div class="card stat-card" style="background: linear-gradient(45deg, #3498db, #2980b9);">
                <h3><i class="fas fa-download"></i> Exportar Backup</h3>
                <p style="font-size: 1rem; margin-top: 10px;">Exporte todos os dados para um arquivo JSON</p>
                <button onclick="exportarBackup()" class="btn-backup" style="margin-top: 15px; width: 100%;">
                    <i class="fas fa-file-export"></i> Exportar Backup Completo
                </button>
            </div>
            
            <div class="card stat-card" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">
                <h3><i class="fas fa-upload"></i> Importar Backup</h3>
                <p style="font-size: 1rem; margin-top: 10px;">Restaurar dados de um arquivo de backup</p>
                <button onclick="document.getElementById('restore-file').click()" class="btn-restore" style="margin-top: 15px; width: 100%;">
                    <i class="fas fa-file-import"></i> Importar Backup
                </button>
                <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="importarBackup(this.files[0])">
            </div>
        </div>
        
        <div class="dashboard-grid mb-4">
            <div class="card stat-card" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                <h3><i class="fas fa-cloud-upload-alt"></i> Salvar na Nuvem</h3>
                <p style="font-size: 1rem; margin-top: 10px;">Armazene o backup no navegador para acesso em qualquer dispositivo</p>
                <button onclick="salvarNaNuvem()" class="btn-cloud" style="margin-top: 15px; width: 100%; background: #f39c12;">
                    <i class="fas fa-cloud-upload-alt"></i> Salvar na Nuvem
                </button>
            </div>
            
            <div class="card stat-card" style="background: linear-gradient(45deg, #9b59b6, #8e44ad);">
                <h3><i class="fas fa-cloud-download-alt"></i> Restaurar da Nuvem</h3>
                <p style="font-size: 1rem; margin-top: 10px;">Restaurar o último backup salvo na nuvem</p>
                <button onclick="restaurarDaNuvem()" class="btn-cloud" style="margin-top: 15px; width: 100%; background: #9b59b6;">
                    <i class="fas fa-cloud-download-alt"></i> Restaurar da Nuvem
                </button>
            </div>
        </div>
        
        <div style="margin-top: 25px; padding: 20px; background: #f8f9ff; border-radius: 10px; border: 1px solid #e0e0ff;">
            <h5><i class="fas fa-info-circle"></i> Informações Importantes</h5>
            <ul style="margin-top: 10px; padding-left: 20px; color: #666; line-height: 1.6;">
                <li><strong>Exportar Backup:</strong> Gera um arquivo JSON com todos os dados do sistema.</li>
                <li><strong>Importar Backup:</strong> Restaura todos os dados a partir de um arquivo de backup.</li>
                <li><strong>Salvar na Nuvem:</strong> Armazena o backup no armazenamento local do navegador.</li>
                <li><strong>Restaurar da Nuvem:</strong> Recupera o último backup salvo na nuvem.</li>
                <li><strong style="color: #e74c3c;">ATENÇÃO:</strong> A restauração substituirá TODOS os dados atuais!</li>
                <li>Recomenda-se fazer backup antes de realizar qualquer restauração.</li>
            </ul>
        </div>
        
        <div id="backup-info" style="margin-top: 20px; padding: 20px; background: #f0f8ff; border-radius: 8px; display: none;"></div>
        
        <div style="margin-top: 30px; padding: 20px; background: #fff8e1; border-radius: 10px; border: 1px solid #ffd54f;">
            <h5><i class="fas fa-exclamation-triangle"></i> Ferramentas Avançadas</h5>
            <div class="form-grid" style="margin-top: 15px;">
                <div class="form-group">
                    <label>Limpar Todos os Dados</label>
                    <button type="button" class="btn-outline w-100" style="border-color: #e74c3c; color: #e74c3c;" 
                            onclick="limparTodosDados()">
                        <i class="fas fa-trash-alt"></i> Limpar Banco de Dados
                    </button>
                </div>
                <div class="form-group">
                    <label>Exportar Logs do Sistema</label>
                    <button type="button" class="btn-outline w-100" onclick="exportarLogs()">
                        <i class="fas fa-file-alt"></i> Exportar Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Script específico para a página de backup
document.addEventListener('DOMContentLoaded', async function() {
    await verificarBackupNuvem();
});

async function verificarBackupNuvem() {
    const backupStr = localStorage.getItem('oficina_cloud_backup');
    if (backupStr) {
        try {
            const backupData = JSON.parse(backupStr);
            const infoDiv = document.getElementById('backup-info');
            
            infoDiv.innerHTML = `
                <div style="color: var(--info-color);">
                    <i class="fas fa-cloud"></i> <strong>Backup na nuvem disponível</strong>
                    <br><small>Data do backup: ${new Date(backupData.metadata?.exportDate || Date.now()).toLocaleString()}</small>
                    <br><small>Registros: ${backupData.metadata?.totalRecords || 'N/A'}</small>
                    <br><small>Pronto para restauração em qualquer dispositivo com esta conta.</small>
                </div>`;
            infoDiv.style.display = 'block';
        } catch (error) {
            console.error('Erro ao verificar backup na nuvem:', error);
        }
    }
}

async function limparTodosDados() {
    if (!confirm("ATENÇÃO CRÍTICA: Esta ação irá APAGAR TODOS os dados do sistema permanentemente. Tem certeza?")) {
        return;
    }
    
    if (!confirm("CONFIRMAÇÃO FINAL: Esta ação NÃO PODE ser desfeita. Todos os dados serão perdidos. Continuar?")) {
        return;
    }
    
    try {
        const stores = [
            'clientes', 'estoque', 'categorias', 'unidades', 
            'cores', 'empresa', 'modelos', 'orcamentos', 
            'vidros_catalogo', 'financeiro'
        ];
        
        for (const store of stores) {
            try {
                await LocalDB.clearAll(store);
            } catch (e) {
                console.log(`Tabela ${store} já vazia ou não existe`);
            }
        }
        
        showNotification('Todos os dados foram removidos do sistema.', 'success');
        
        // Recarregar a página
        setTimeout(() => {
            window.location.reload();
        }, 2000);
        
    } catch (error) {
        console.error('Erro ao limpar dados:', error);
        showNotification('Erro ao limpar dados.', 'error');
    }
}

async function exportarLogs() {
    try {
        const logs = {
            clientes: await LocalDB.getAll('clientes'),
            estoque: await LocalDB.getAll('estoque'),
            orcamentos: await LocalDB.getAll('orcamentos'),
            financeiro: await LocalDB.getAll('financeiro'),
            modelos: await LocalDB.getAll('modelos'),
            exportDate: new Date().toISOString(),
            totalRecords: 0
        };
        
        // Calcular total de registros
        logs.totalRecords = Object.values(logs).reduce((acc, curr) => {
            if (Array.isArray(curr)) {
                return acc + curr.length;
            }
            return acc;
        }, 0);
        
        // Criar arquivo JSON
        const jsonStr = JSON.stringify(logs, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Criar link para download
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `logs_oficina_${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('Logs exportados com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao exportar logs:', error);
        showNotification('Erro ao exportar logs.', 'error');
    }
}
</script>